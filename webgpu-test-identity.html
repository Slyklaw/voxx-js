<!DOCTYPE html>
<html>
<head>
    <title>WebGPU Identity Matrix Test</title>
    <style>
        body { margin: 0; background: #000; }
        canvas { display: block; }
    </style>
</head>
<body>
    <canvas id="canvas" width="800" height="600"></canvas>
    <div id="status" style="position: absolute; top: 10px; left: 10px; color: white;">Testing with identity matrices...</div>
    
    <script type="module">
        import { WebGPURenderer } from './webgpu/webgpu-renderer.js';
        
        async function testIdentity() {
            const canvas = document.getElementById('canvas');
            const status = document.getElementById('status');
            
            try {
                // Initialize renderer
                const renderer = new WebGPURenderer();
                await renderer.init(canvas);
                
                // Create a simple triangle in clip space
                const vertices = new Float32Array([
                    // Position (x,y,z), Normal (x,y,z), Color (r,g,b)
                     0.0,  0.5, 0.0,  0, 0, 1,  1, 0, 0,  // top (red)
                    -0.5, -0.5, 0.0,  0, 0, 1,  0, 1, 0,  // bottom-left (green)
                     0.5, -0.5, 0.0,  0, 0, 1,  0, 0, 1,  // bottom-right (blue)
                ]);
                
                // Create vertex buffer
                const vertexBuffer = renderer.device.createBuffer({
                    size: vertices.byteLength,
                    usage: GPUBufferUsage.VERTEX | GPUBufferUsage.COPY_DST
                });
                renderer.device.queue.writeBuffer(vertexBuffer, 0, vertices);
                
                // Create fake chunk object
                const testChunk = {
                    vertexBuffer: vertexBuffer,
                    indexBuffer: null,
                    indexCount: 0
                };
                
                // Use identity matrices (no transformation)
                const identityMatrix = new Float32Array([
                    1, 0, 0, 0,
                    0, 1, 0, 0,
                    0, 0, 1, 0,
                    0, 0, 0, 1
                ]);
                
                const lightDirection = [0.5, -1.0, 0.5];
                const lightColor = [1.0, 1.0, 1.0];
                const ambientColor = [0.3, 0.3, 0.3];
                
                renderer.updateUniforms(
                    identityMatrix,  // viewProjection = identity
                    identityMatrix,  // model = identity
                    lightDirection,
                    lightColor,
                    ambientColor
                );
                
                // Render using draw instead of drawIndexed
                const commandEncoder = renderer.device.createCommandEncoder();
                const renderPass = commandEncoder.beginRenderPass({
                    colorAttachments: [{
                        view: renderer.context.getCurrentTexture().createView(),
                        clearValue: { r: 0.0, g: 0.0, b: 0.5, a: 1.0 },
                        loadOp: 'clear',
                        storeOp: 'store'
                    }]
                });

                renderPass.setPipeline(renderer.renderPipeline);
                
                // Create bind group for uniforms
                const bindGroup = renderer.device.createBindGroup({
                    layout: renderer.renderPipeline.getBindGroupLayout(0),
                    entries: [{
                        binding: 0,
                        resource: {
                            buffer: renderer.uniformBuffer
                        }
                    }]
                });
                
                renderPass.setBindGroup(0, bindGroup);
                renderPass.setVertexBuffer(0, vertexBuffer);
                renderPass.draw(3); // Draw 3 vertices (1 triangle)
                renderPass.end();
                
                renderer.device.queue.submit([commandEncoder.finish()]);
                
                status.textContent = '✅ Identity matrix test! Should see a triangle with identity transforms.';
                
            } catch (error) {
                status.textContent = `❌ Error: ${error.message}`;
                console.error(error);
            }
        }
        
        testIdentity();
    </script>
</body>
</html>